{% extends "base.html" %}
{% block title %}User List{% endblock %}

{% block menu_header %}
{% include 'menu.html' %}
{% endblock %}

{% block content %}
{% load static %}
{% load user_tags %}
<script src="{% static 'js/script.js' %}"></script>
<script src="{% static 'js/user_avatar.js' %}"></script>
<script>
    $(document).ready(function () {

        // New User modal
        $('#newUser').on('shown.bs.modal', function () {
            $(this).find('.select2').select2({
                width: '100%',
                placeholder: 'Select Groups',
                dropdownParent: $('#newUser')
            });
        });
        // Edit User modals (‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß)
        $('.modal[id^="editUser"]').on('shown.bs.modal', function () {
            $(this).find('.select2').select2({
                width: '100%',
                placeholder: 'Select Groups',
                dropdownParent: $(this)
            });
        });
    });
</script>
<h3>User List</h3>
<div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    <!-- Import Form -->
    <form method="post" action="{% url 'import_users_excel' %}" enctype="multipart/form-data"
        class="d-flex gap-2 align-items-center">
        {% csrf_token %}
        <input type="file" name="file" accept=".xlsx" required class="form-control form-control-sm">
        <button type="submit" class="btn btn-sm btn-light">
            <i class="fa fa-cloud-download " style="font-size:18px;color:rgb(0, 55, 255)"></i>
        </button>
    </form>
    <!-- Export Button -->
    <a href="{% url 'export_users_excel' %}" style="padding-right: 10px;">
        <i class="fa fa-upload" style="font-size:18px;color:red"></i>
    </a>
    <!-- Register Button -->
    <a href="{% url 'register_on_system' %}" data-bs-toggle="modal" data-bs-target="#newUser">
        <i class="fa fa-save" style="font-size: 18px;color:blue"></i>
    </a>
</div>
<!-- new Modal -->
<div class="modal fade" id="newUser">
    <div class="modal-dialog modal-lg" style="max-width: 900px;">
        <div class="modal-content">
            <form method="post" enctype="multipart/form-data" action="{% url 'register_on_system'%}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <img src="{% static 'img/avatar.png' %}" class="avatar-preview border" width="150" height="150"
                            style="border-radius: 50%; object-fit: cover;">
                        <input type="file" name="avatar" class="avatar-input d-none" accept="image/*">
                        <input type="hidden" name="remove_avatar" class="avatar-remove-flag">
                        <div class="avatar-actions mt-2">
                            <button type="button"
                                class="btn btn-sm btn-outline-primary btn-avatar-change">Change</button>
                            <button type="button"
                                class="btn btn-sm btn-outline-danger btn-avatar-remove">Remove</button>
                        </div>
                    </div>
                    {{ create_form.as_p }}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="row table-responsive">
    <div class="col-md-12">
        <table class="table table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Avatar</th>
                    <th>Fullname</th>
                    <th class="d-none d-sm-table-cell">Last Name</th>
                    <th class="d-none d-sm-table-cell">Phone</th>
                    <th class="d-none d-sm-table-cell">Username</th>
                    <th class="d-none d-sm-table-cell">Email</th>
                    <th class="d-none d-sm-table-cell">Department</th>
                    <th class="d-none d-sm-table-cell">Groups</th>
                    <th class="d-none d-md-table-cell">Last Device</th>

                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user, form in user_with_forms %}
                <tr class="align-middle">
                    <td>
                        <img src="{% if user.avatar %}{{ user.avatar.url }}{% else %}{% static 'img/avatar.png' %}{% endif %}"
                            class="avatar-preview" width="80" height="80" style="border-radius:50%; object-fit:cover;">
                    </td>
                    <td>{{ user.first_name }}</td>
                    <td class="d-none d-sm-table-cell">{{ user.last_name }}</td>
                    <td class="d-none d-sm-table-cell">{{ user.phone }}</td>
                    <td class="d-none d-sm-table-cell">{{ user.username }}</td>
                    <td class="d-none d-sm-table-cell">{{ user.email }}</td>
                    <td class="d-none d-sm-table-cell">{{ user.department }}</td>
                    <td class="d-none d-sm-table-cell">
                        {% for group in user.groups.all %}
                        <span class="badge bg-primary">{{ group.name }}</span>
                        {% empty %}
                        <span class="badge bg-secondary">No Group</span>
                        {% endfor %}
                    </td>
                    <td class="d-none d-md-table-cell">
                        {% if user.last_device %}
                        <small>
                            üñ• {{ user.last_device }}<br>
                            {{ user.last_os }} ¬∑ {{ user.last_browser }}<br>
                            IP: {{ user.last_ip }}<br>
                            <span class="text-muted">
                                {{ user.last_activity|date:"d-m-Y H:i" }}
                            </span>
                        </small>
                        {% else %}
                        <span class="text-muted">Never login</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal"
                            data-bs-target="#editUser{{ user.id }}">
                            <i class="fa fa-edit" style="font-size:18px;color:orange"></i>
                        </button>
                        <a href="{% url 'delete_user' user.id %}" class="btn btn-sm btn-outline-danger btn-delete"
                            data-name="{{ user.username }}">
                            <i class="fa fa-trash" style="font-size:18px;color:red"></i></a>
                        <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal"
                            data-bs-target="#passwordModal{{ user.id }}">
                            Password
                        </button>

                        <!-- Modal -->
                        <div class="modal fade" id="passwordModal{{ user.id }}" tabindex="-1"
                            aria-labelledby="passwordModalLabel{{ user.id }}" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form method="post" action="{% url 'change_password' user.id %}">
                                        {% csrf_token %}
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="passwordModalLabel{{ user.id }}">Change Password
                                                for {{ user.username }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label>New Password</label>
                                                <input type="password" name="password" class="form-control" required>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary"
                                                data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-success">Update Password</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <!-- Edit Modal -->
                        <div class="modal fade" id="editUser{{ user.id }}">
                            <div class="modal-dialog modal-lg" style="max-width: 900px;">
                                <div class="modal-content">
                                    <form method="post" enctype="multipart/form-data"
                                        action="{% url 'edit_user' user.id %}">
                                        {% csrf_token %}
                                        <div class="modal-header">
                                            <h5 class="modal-title">Edit User</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="text-center mb-3">
                                                <img src="{% if user.avatar %}{{ user.avatar.url }}{% else %}{% static 'img/avatar.png' %}{% endif %}"
                                                    class="avatar-preview border" width="150" height="150"
                                                    style="border-radius: 50%; object-fit: cover;">
                                                <input type="file" name="avatar" class="avatar-input d-none"
                                                    accept="image/*">
                                                <input type="hidden" name="remove_avatar" class="avatar-remove-flag">
                                                <div class="avatar-actions mt-2">
                                                    <button type="button"
                                                        class="btn btn-sm btn-outline-primary btn-avatar-change">Change</button>
                                                    <button type="button"
                                                        class="btn btn-sm btn-outline-danger btn-avatar-remove">Remove</button>
                                                </div>
                                            </div>
                                            {{ form.as_p }}
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-success">Save</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <!-- End Modal -->
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}